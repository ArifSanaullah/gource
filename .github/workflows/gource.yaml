# This is a basic workflow to help you get started with Actions

name: Testing gource

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
    push:
        branches: [main]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest
        name: Setting up gource

        steps:
            - uses: actions/checkout@v2
            - name: Install gource & xvfb
              run: sudo apt-get install gource xvfb -y
            - name: Install ffmpeg & gifski
              run: sudo apt-get update && sudo snap install ffmpeg gifski
            - name: hide display
              run: Xvfb -a -ac -screen 0 1280x720x24 -nolisten tcp &
            - name: mkdir xdg
              run: sudo mkdir -p /tmp/xdg
            - name: XDG runtime
              run: export XDG_RUNTIME_DIR=/tmp/xdg
            - name: SET DISPLAY
              run: export DISPLAY=:99
            - name: Run gource with xvfb
              run: xvfb-run --auto-servernum --server-num=99 gource -1280x720 -o - | ffmpeg -y -r 60 -f image2pipe -vcodec ppm -i - -vcodec libx264 -preset ultrafast -pix_fmt yuv420p -crf 1 -threads 0 -bf 0 gource.mp4
            - name: create frames dir
              run: mkdir frames
            - name: Create images from video & del video
              run: ffmpeg -i ./gource.mp4  -r 5 frames/%04d.png && rm ./gource.mp4
            - name: del old gif & Create gif from images & del frames
              run: rm -f ./gource.gif && gifski -o gource.gif ./frames/*.png && rm -rf ./frames
            - name: List directory contents
              run: sudo find .
            # - name: setup git
            #   uses: actions/checkout@master
            #   with:
            #       persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
            #       fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
            # - name: Commit & Push changes
            #   uses: actions-js/push@master
            #   with:
            #       github_token: ${{ secrets.GITHUB_TOKEN }}
            # - name: Git Commit and Push
            # uses: github-actions-x/commit@v2.6
